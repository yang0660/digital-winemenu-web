<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myicellar.digitalmenu.dao.mapper.WineAttrMapperExt">
  <resultMap id="BaseResultMap" type="com.myicellar.digitalmenu.dao.entity.WineAttr">
    <id column="attr_id" jdbcType="BIGINT" property="attrId" />
    <id column="wine_id" jdbcType="BIGINT" property="wineId" />
    <result column="mic_rank" jdbcType="SMALLINT" property="micRank" />
    <result column="updated_at" jdbcType="TIMESTAMP" property="updatedAt" />
  </resultMap>
  <sql id="Base_Column_List">
    attr_id, wine_id, mic_rank, updated_at
  </sql>
  <select id="selectCount" parameterType="com.myicellar.digitalmenu.vo.request.WineAttrPageReqVO" resultType="long">
    select count(0)
    from t_wine
    where wine_id = #{wineId}
  </select>

  <select id="selectList" parameterType="com.myicellar.digitalmenu.vo.request.WineAttrPageReqVO"
          resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from t_wine
    where wine_id = #{wineId}
    limit #{offset,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
  </select>

  <resultMap id="WineAttrInfoResultMap" type="com.myicellar.digitalmenu.vo.response.WineAttrMapRespVO">
      <result column="wineId" jdbcType="BIGINT" property="wineId" />
      <result column="attrCatgId" jdbcType="BIGINT" property="attrCatgId" />
    <collection property="list" column="{wineId=wineId,attrCatgId=attrCatgId}" javaType="ArrayList" select="selectAttrListByWineId" />
  </resultMap>

  <resultMap id="WineAttrResultMap" type="com.myicellar.digitalmenu.vo.response.WineAttrInfoRespVO">
    <result column="attr_name_eng" jdbcType="VARCHAR" property="attrNameEng" />
    <result column="attr_name_chs" jdbcType="VARCHAR" property="attrNameChs" />
    <result column="attr_name_cht" jdbcType="VARCHAR" property="attrNameCht" />
  </resultMap>

  <select id="selectAttrMapByWineIds" resultMap="WineAttrInfoResultMap">
    SELECT distinct
           a.wine_id as wineId,
           b.attr_catg_id as attrCatgId
    FROM t_wine_attr a
    INNER JOIN t_attr b ON a.attr_id = b.attr_id
    AND b.attr_catg_id = #{attrCatgId,jdbcType=BIGINT}
    WHERE a.wine_id IN
    <foreach collection="wineIds" item="wineId" open="(" close=")" separator=",">
      #{wineId,jdbcType=BIGINT}
    </foreach>
  </select>

  <select id="selectAttrListByWineId" parameterType="java.util.Map" resultMap="WineAttrResultMap">
    SELECT b.attr_name_eng,
    b.attr_name_chs,
    b.attr_name_cht
    FROM t_wine_attr a
    INNER JOIN t_attr b ON a.attr_id = b.attr_id
    AND b.attr_catg_id = #{attrCatgId,jdbcType=BIGINT}
    WHERE a.wine_id = #{wineId,jdbcType=BIGINT}
  </select>
</mapper>