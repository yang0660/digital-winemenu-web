<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myicellar.digitalmenu.dao.mapper.IPackageMapperExt">
  <resultMap id="BaseResultMap" type="com.myicellar.digitalmenu.dao.entity.IPackage"
             extends="com.myicellar.digitalmenu.dao.mapper.IPackageMapper.BaseResultMap">
  </resultMap>

  <sql id="Base_Column_List">
    <include refid="com.myicellar.digitalmenu.dao.mapper.IPackageMapper.Base_Column_List"/>
  </sql>

  <resultMap id="PackageInfoResultMap" type="com.myicellar.digitalmenu.vo.response.PackageInfoRespVO">
    <id column="package_id" jdbcType="BIGINT" property="packageId" />
    <result column="wine_id" jdbcType="BIGINT" property="wineId" />
    <result column="wine_name_eng" jdbcType="VARCHAR" property="wineNameEng" />
    <result column="wine_name_chs" jdbcType="VARCHAR" property="wineNameChs" />
    <result column="wine_name_cht" jdbcType="VARCHAR" property="wineNameCht" />
    <result column="wine_type_name_eng" jdbcType="VARCHAR" property="wineTypeNameEng" />
    <result column="winery_id" jdbcType="BIGINT" property="wineryId" />
    <result column="winery_name_eng" jdbcType="VARCHAR" property="wineryNameEng" />
    <result column="supplier_id" jdbcType="BIGINT" property="supplierId" />
    <result column="regular_price" jdbcType="DECIMAL" property="regularPrice" />
    <result column="glass_price" jdbcType="DECIMAL" property="glassPrice" />
    <result column="vintage_tag" jdbcType="BIGINT" property="vintageTag" />
    <result column="vintage_name" jdbcType="VARCHAR" property="vintageName" />
    <result column="country_name_eng" jdbcType="VARCHAR" property="countryNameEng" />
    <result column="country_name_chs" jdbcType="VARCHAR" property="countryNameChs" />
    <result column="country_name_cht" jdbcType="VARCHAR" property="countryNameCht" />
    <result column="region_name_eng" jdbcType="VARCHAR" property="regionNameEng" />
    <result column="region_name_chs" jdbcType="VARCHAR" property="regionNameChs" />
    <result column="region_name_cht" jdbcType="VARCHAR" property="regionNameCht" />
    <result column="wine_img_id" jdbcType="BIGINT" property="wineImgId" />
    <result column="winery_logo_id" jdbcType="BIGINT" property="wineryLogoId" />
  </resultMap>

  <select id="selectRecomendPackageList" parameterType="long" resultMap="PackageInfoResultMap">
    SELECT
    pkg.package_id,
    pkg.regular_price,
    prd.wine_id,
    prd.supplier_id,
    win.wine_name_eng,
    win.wine_name_chs,
    win.wine_name_cht,
    winry.winery_id,
    winry.winery_name_eng,
    winry.logo_img_id AS winery_logo_id,
    org.region_name_eng,
    org.region_name_chs,
    org.region_name_cht,
    ctry.country_name_eng,
    ctry.country_name_chs,
    ctry.country_name_cht,
    winvtg.vintage_tag,
    winvtg.vintage_name,
    win.wine_img_id
    FROM
    t_package pkg
    INNER JOIN t_product prd ON pkg.product_id = prd.product_id
    INNER JOIN t_wine_vintage winvtg ON prd.wine_id = winvtg.wine_id
    AND prd.vintage_tag = winvtg.vintage_tag
    INNER JOIN t_wine win ON prd.wine_id = win.wine_id
    LEFT JOIN t_winery winry ON win.winery_id = winry.winery_id
    LEFT JOIN t_origin org ON win.wine_origin_id = org.wine_origin_id
    LEFT JOIN t_country ctry ON org.country_id = ctry.country_id
    WHERE
    prd.is_recommend = 1
    AND prd.supplier_id = #{supplierId}
  </select>

  <select id="selectPackageListByFoodId" parameterType="long" resultMap="PackageInfoResultMap">
    SELECT
    pkg.package_id,
    pkg.regular_price,
    prd.wine_id,
    prd.supplier_id,
    win.wine_name_eng,
    win.wine_name_chs,
    win.wine_name_cht,
    winry.winery_id,
    winry.winery_name_eng,
    winry.logo_img_id AS winery_logo_id,
    org.region_name_eng,
    org.region_name_chs,
    org.region_name_cht,
    ctry.country_name_eng,
    ctry.country_name_chs,
    ctry.country_name_cht,
    winvtg.vintage_tag,
    winvtg.vintage_name,
    win.wine_img_id
    FROM
    t_package pkg
    INNER JOIN t_food_package fpkg ON pkg.package_id = fpkg.package_id
    INNER JOIN t_product prd ON pkg.product_id = prd.product_id
    INNER JOIN t_wine_vintage winvtg ON prd.wine_id = winvtg.wine_id
    AND prd.vintage_tag = winvtg.vintage_tag
    INNER JOIN t_wine win ON prd.wine_id = win.wine_id
    LEFT JOIN t_winery winry ON win.winery_id = winry.winery_id
    LEFT JOIN t_origin org ON win.wine_origin_id = org.wine_origin_id
    LEFT JOIN t_country ctry ON org.country_id = ctry.country_id
    WHERE
    fpkg.food_id = #{foodId}
  </select>

  <select id="selectPackageListByIds"  resultMap="PackageInfoResultMap">
    SELECT
    pkg.package_id,
    pkg.regular_price,
    pkg.glass_price,
    prd.wine_id,
    prd.supplier_id,
    win.wine_name_eng,
    win.wine_name_chs,
    win.wine_name_cht,
    wintype.wine_type_name_eng,
    winry.winery_id,
    winry.winery_name_eng,
    winry.logo_img_id AS winery_logo_id,
    org.region_name_eng,
    org.region_name_chs,
    org.region_name_cht,
    ctry.country_name_eng,
    ctry.country_name_chs,
    ctry.country_name_cht,
    winvtg.vintage_tag,
    winvtg.vintage_name,
    win.wine_img_id
    FROM
    t_package pkg
    INNER JOIN t_product prd ON pkg.product_id = prd.product_id
    INNER JOIN t_wine_vintage winvtg ON prd.wine_id = winvtg.wine_id
    AND prd.vintage_tag = winvtg.vintage_tag
    INNER JOIN t_wine win ON prd.wine_id = win.wine_id
    INNER JOIN t_wine_type wintype ON win.wine_type_id = wintype.wine_type_id
    LEFT JOIN t_winery winry ON win.winery_id = winry.winery_id
    LEFT JOIN t_origin org ON win.wine_origin_id = org.wine_origin_id
    LEFT JOIN t_country ctry ON org.country_id = ctry.country_id
    WHERE
    pkg.package_id IN
    <foreach collection="packageIds" item="packageId" open="(" close=")" separator=",">
      #{packageId,jdbcType=BIGINT}
    </foreach>
  </select>

  <select id="selectPriceRange" parameterType="long" resultType="com.myicellar.digitalmenu.vo.response.PackagePriceRangeRespVO">
    SELECT
    max( a.regular_price ) AS minPackagePrice,
    max( a.regular_price ) AS maxPackagePrice
    FROM
    t_package a
    INNER JOIN t_product b ON a.product_id = b.product_id
    WHERE
    b.supplier_id = #{supplierId}
  </select>

  <select id="selectResultCount" parameterType="com.myicellar.digitalmenu.vo.request.PackageFilterReqVO"
          resultType="long">
    select
    count(distinct pkg.package_id)
    FROM
    t_package pkg
    INNER JOIN t_product prd ON pkg.product_id = prd.product_id
    INNER JOIN t_wine_vintage winvtg ON prd.wine_id = winvtg.wine_id
    AND prd.vintage_tag = winvtg.vintage_tag
    INNER JOIN t_wine win ON prd.wine_id = win.wine_id
    INNER JOIN t_wine_type wintype ON win.wine_type_id = wintype.wine_type_id
    LEFT JOIN t_winery winry ON win.winery_id = winry.winery_id
    LEFT JOIN t_origin org ON win.wine_origin_id = org.wine_origin_id
    LEFT JOIN t_country ctry ON org.country_id = ctry.country_id
    LEFT JOIN t_wine_attr winattr ON win.wine_id = winattr.wine_id
    LEFT JOIN t_attr attr ON winattr.attr_id = attr.attr_id
    AND attr_catg_id = 101
    WHERE
    prd.supplier_id = #{supplierId}
    <if test="priceMin!=null and priceMin!=0">
      AND pkg.regular_price &gt;#{priceMin}
    </if>
    <if test="priceMax!=null and priceMax!=0">
      AND pkg.regular_price &lt;#{priceMax}
    </if>
    <if test="wineTypeIds!=null and wineTypeIds.size()>0">
      AND wine.wine_type_id IN
      <foreach collection="wineTypeIds" item="wineTypeId" open="(" close=")" separator=",">
        #{wineTypeId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="countryIds!=null and countryIds.size()>0">
      AND ori.country_id IN
      <foreach collection="countryIds" item="countryId" open="(" close=")" separator=",">
        #{countryId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="attrIds!=null and attrIds.size()>0">
      AND attr.attr_id IN
      <foreach collection="attrIds" item="attrId" open="(" close=")" separator=",">
        #{attrId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="wineOriginIds!=null and wineOriginIds.size()>0">
      AND wine.wine_origin_id IN
      <foreach collection="wineOriginIds" item="wineOriginId" open="(" close=")" separator=",">
        #{wineOriginId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="isGlassWine==1">
      AND pkg.glass_price &lt;&gt; 0.00
    </if>
    <if test="isOrganicWine==1">
      AND prd.is_organic_wine = 1
    </if>
  </select>

  <select id="selectResult" parameterType="com.myicellar.digitalmenu.vo.request.PackageFilterReqVO"
          resultMap="PackageInfoResultMap">
    SELECT DISTINCT
    pkg.package_id,
    pkg.regular_price,
    pkg.glass_price,
    prd.wine_id,
    prd.supplier_id,
    win.wine_name_eng,
    win.wine_name_chs,
    win.wine_name_cht,
    wintype.wine_type_name_eng,
    winry.winery_id,
    winry.winery_name_eng,
    winry.logo_img_id AS winery_logo_id,
    org.region_name_eng,
    org.region_name_chs,
    org.region_name_cht,
    ctry.country_name_eng,
    ctry.country_name_chs,
    ctry.country_name_cht,
    winvtg.vintage_tag,
    winvtg.vintage_name,
    win.wine_img_id
    FROM
    t_package pkg
    INNER JOIN t_product prd ON pkg.product_id = prd.product_id
    INNER JOIN t_wine_vintage winvtg ON prd.wine_id = winvtg.wine_id
    AND prd.vintage_tag = winvtg.vintage_tag
    INNER JOIN t_wine win ON prd.wine_id = win.wine_id
    INNER JOIN t_wine_type wintype ON win.wine_type_id = wintype.wine_type_id
    LEFT JOIN t_winery winry ON win.winery_id = winry.winery_id
    LEFT JOIN t_origin org ON win.wine_origin_id = org.wine_origin_id
    LEFT JOIN t_country ctry ON org.country_id = ctry.country_id
    LEFT JOIN t_wine_attr winattr ON win.wine_id = winattr.wine_id
    LEFT JOIN t_attr attr ON winattr.attr_id = attr.attr_id
    AND attr_catg_id = 101
    WHERE
    prd.supplier_id = #{supplierId}
    <if test="priceMin!=null and priceMin!=0">
      AND pkg.regular_price &gt;#{priceMin}
    </if>
    <if test="priceMax!=null and priceMax!=0">
      AND pkg.regular_price &lt;#{priceMax}
    </if>
    <if test="wineTypeIds!=null and wineTypeIds.size()>0">
      AND wine.wine_type_id IN
      <foreach collection="wineTypeIds" item="wineTypeId" open="(" close=")" separator=",">
        #{wineTypeId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="countryIds!=null and countryIds.size()>0">
      AND ori.country_id IN
      <foreach collection="countryIds" item="countryId" open="(" close=")" separator=",">
        #{countryId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="attrIds!=null and attrIds.size()>0">
      AND attr.attr_id IN
      <foreach collection="attrIds" item="attrId" open="(" close=")" separator=",">
        #{attrId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="wineOriginIds!=null and wineOriginIds.size()>0">
      AND wine.wine_origin_id IN
      <foreach collection="wineOriginIds" item="wineOriginId" open="(" close=")" separator=",">
        #{wineOriginId,jdbcType=BIGINT}
      </foreach>
    </if>
    <if test="isGlassWine==1">
      AND pkg.glass_price &lt;&gt; 0.00
    </if>
    <if test="isOrganicWine==1">
      AND prd.is_organic_wine = 1
    </if>
    limit #{offset,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
  </select>
</mapper>