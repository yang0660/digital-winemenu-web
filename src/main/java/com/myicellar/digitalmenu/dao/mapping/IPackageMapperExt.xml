<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myicellar.digitalmenu.dao.mapper.IPackageMapperExt">
  <resultMap id="BaseResultMap" type="com.myicellar.digitalmenu.dao.entity.IPackage"
             extends="com.myicellar.digitalmenu.dao.mapper.IPackageMapper.BaseResultMap">
  </resultMap>

  <sql id="Base_Column_List">
    <include refid="com.myicellar.digitalmenu.dao.mapper.IPackageMapper.Base_Column_List"/>
  </sql>

  <resultMap id="PackageInfoResultMap" type="com.myicellar.digitalmenu.vo.response.PackageInfoRespVO">
    <id column="package_id" jdbcType="BIGINT" property="packageId" />
    <result column="wine_id" jdbcType="BIGINT" property="wineId" />
    <result column="wine_type_name_eng" jdbcType="VARCHAR" property="wineTypeNameEng" />
    <result column="wine_name_eng" jdbcType="VARCHAR" property="wineNameEng" />
    <result column="wine_name_chs" jdbcType="VARCHAR" property="wineNameChs" />
    <result column="wine_name_cht" jdbcType="VARCHAR" property="wineNameCht" />
    <result column="winery_id" jdbcType="BIGINT" property="wineryId" />
    <result column="winery_name_eng" jdbcType="VARCHAR" property="wineryNameEng" />
    <result column="supplier_id" jdbcType="BIGINT" property="supplierId" />
    <result column="regular_price" jdbcType="DECIMAL" property="regularPrice" />
    <result column="glass_price" jdbcType="DECIMAL" property="glassPrice" />
    <result column="vintage_tag" jdbcType="BIGINT" property="vintageTag" />
    <result column="vintage_name" jdbcType="VARCHAR" property="vintageName" />
    <result column="country_name_eng" jdbcType="VARCHAR" property="countryNameEng" />
    <result column="country_name_chs" jdbcType="VARCHAR" property="countryNameChs" />
    <result column="country_name_cht" jdbcType="VARCHAR" property="countryNameCht" />
    <result column="region_name_eng" jdbcType="VARCHAR" property="regionNameEng" />
    <result column="region_name_chs" jdbcType="VARCHAR" property="regionNameChs" />
    <result column="region_name_cht" jdbcType="VARCHAR" property="regionNameCht" />
    <result column="wine_img_id" jdbcType="BIGINT" property="wineImgId" />
    <result column="winery_logo_id" jdbcType="BIGINT" property="wineryLogoId" />
  </resultMap>

  <select id="selectRecomendPackageList" parameterType="long" resultMap="PackageInfoResultMap">
    SELECT
    g.package_id,
    e.supplier_id,
    a.wine_id,
    a.wine_name_eng,
    a.wine_name_chs,
    a.wine_name_cht,
    a.winery_id,
    d.winery_name_eng,
    d.logo_img_id AS winery_logo_id,
    b.region_name_eng,
    b.region_name_chs,
    b.region_name_cht,
    c.country_name_eng,
    c.country_name_chs,
    c.country_name_cht,
    e.vintage_tag,
    f.vintage_name,
    g.regular_price,
    a.wine_img_id
    FROM
    t_wine a
    INNER JOIN t_origin b ON a.wine_origin_id = b.wine_origin_id
    INNER JOIN t_country c ON b.country_id = c.country_id
    INNER JOIN t_winery d ON a.winery_id = d.winery_id
    INNER JOIN t_product e ON a.wine_id = e.wine_id
    INNER JOIN t_package g ON e.product_id = g.product_id
    INNER JOIN t_wine_vintage f ON e.wine_id = f.wine_id
    AND e.vintage_tag = f.vintage_tag
    WHERE
    e.is_recommend = 1
    AND e.supplier_id = #{supplierId}
  </select>

  <select id="selectPackageListByFoodId" parameterType="long" resultMap="PackageInfoResultMap">
    SELECT
    pkg.package_id,
    e.supplier_id,
    a.wine_id,
    a.wine_name_eng,
    a.wine_name_chs,
    a.wine_name_cht,
    a.winery_id,
    d.winery_name_eng,
    d.logo_img_id AS winery_logo_id,
    b.region_name_eng,
    b.region_name_chs,
    b.region_name_cht,
    c.country_name_eng,
    c.country_name_chs,
    c.country_name_cht,
    e.vintage_tag,
    f.vintage_name,
    pkg.regular_price,
    a.wine_img_id
    FROM
    t_wine a
    INNER JOIN t_origin b ON a.wine_origin_id = b.wine_origin_id
    INNER JOIN t_country c ON b.country_id = c.country_id
    INNER JOIN t_winery d ON a.winery_id = d.winery_id
    INNER JOIN t_product e ON a.wine_id = e.wine_id
    INNER JOIN t_package pkg ON e.product_id = pkg.product_id
    INNER JOIN t_wine_vintage f ON e.wine_id = f.wine_id
    AND e.vintage_tag = f.vintage_tag
    INNER JOIN t_food_product g ON e.product_id = g.product_id
    WHERE g.food_id = #{foodId}
  </select>

  <select id="selectPackageListByIds"  resultMap="PackageInfoResultMap">
    SELECT
    pkg.package_id,
    e.supplier_id,
    a.wine_id,
    a.wine_name_eng,
    a.wine_name_chs,
    a.wine_name_cht,
    h.wine_type_name_eng,
    a.winery_id,
    d.winery_name_eng,
    d.logo_img_id AS winery_logo_id,
    b.region_name_eng,
    b.region_name_chs,
    b.region_name_cht,
    c.country_name_eng,
    c.country_name_chs,
    c.country_name_cht,
    e.vintage_tag,
    f.vintage_name,
    pkg.regular_price,
    pkg.glass_price,
    a.wine_img_id
    FROM
    t_wine a
    INNER JOIN t_origin b ON a.wine_origin_id = b.wine_origin_id
    INNER JOIN t_country c ON b.country_id = c.country_id
    INNER JOIN t_winery d ON a.winery_id = d.winery_id
    INNER JOIN t_wine_type h ON a.wine_type_id = h.wine_type_id
    INNER JOIN t_product e ON a.wine_id = e.wine_id
    INNER JOIN t_package pkg ON e.product_id = pkg.product_id
    INNER JOIN t_wine_vintage f ON e.wine_id = f.wine_id
    AND e.vintage_tag = f.vintage_tag
    INNER JOIN t_food_product g ON e.product_id = g.product_id
    WHERE pkg.package_id IN
    <foreach collection="packageIds" item="packageId" open="(" close=")" separator=",">
      #{packageId,jdbcType=BIGINT}
    </foreach>
  </select>

  <select id="selectPriceRange" parameterType="long" resultType="com.myicellar.digitalmenu.vo.response.PackagePriceRangeRespVO">
    SELECT
    max( a.regular_price ) AS minPackagePrice,
    max( a.regular_price ) AS maxPackagePrice
    FROM
    t_package a
    INNER JOIN t_product b ON a.product_id = b.product_id
    WHERE
    b.supplier_id = #{supplierId}
  </select>

  <select id="selectResultCount" parameterType="com.myicellar.digitalmenu.vo.request.PackageFilterReqVO"
          resultType="long">
    select
    count(distinct pkg.package_id)
    from
    t_wine wine
    inner join t_product prod on wine.wine_id =prod.wine_id
    inner join t_wine_type wty on wine.wine_type_id=wty.wine_type_id
    inner join t_wine_vintage vtg on prod.vintage_tag=vtg.vintage_tag
    inner join t_package pkg on prod.product_id=pkg.product_id
    inner join t_origin ori on wine.wine_origin_id=ori.wine_origin_id
    inner join t_country cty on ori.country_id=cty.country_id
    where pkg.regular_price &gt; #{priceMin}
    and pkg.regular_price &lt; #{priceMax}
    <if test="supplierId!=null and supplierId!=0">
      and prod.supplier_id=#{supplierId}
    </if>
    <if test="wineTypeId!=null and wineTypeId!=0">
      and wine.wine_type_id=#{wineTypeId}
    </if>
    <if test="countryId!=null and countryId!=0">
      and ori.country_id=#{countryId}
    </if>
    <if test="wineOriginId!=null and wineOriginId!=0">
      and wine.wine_origin_id=#{wineOriginId}
    </if>
  </select>

  <select id="selectResult" parameterType="com.myicellar.digitalmenu.vo.request.PackageFilterReqVO"
          resultMap="PackageInfoResultMap">
    select
    DISTINCT
    pkg.package_id,
    wine.wine_id,
    wine.wine_name_eng,
    wty.wine_type_name_eng,
    ori.region_name_eng,
    cty.country_name_eng,
    vtg.vintage_name,
    pkg.regular_price,
    pkg.glass_price,
    wine.wine_img_id
    from
    t_wine wine
    inner join t_product prod on wine.wine_id =prod.wine_id
    inner join t_wine_type wty on wine.wine_type_id=wty.wine_type_id
    inner join t_wine_vintage vtg on prod.vintage_tag=vtg.vintage_tag
    inner join t_package pkg on prod.product_id=pkg.product_id
    inner join t_origin ori on wine.wine_origin_id=ori.wine_origin_id
    inner join t_country cty on ori.country_id=cty.country_id
    where pkg.regular_price &gt; #{priceMin}
    and pkg.regular_price &lt; #{priceMax}
    <if test="supplierId!=null and supplierId!=0">
      and prod.supplier_id=#{supplierId}
    </if>
    <if test="wineTypeId!=null and wineTypeId!=0">
      and wine.wine_type_id=#{wineTypeId}
    </if>
    <if test="countryId!=null and countryId!=0">
      and ori.country_id=#{countryId}
    </if>
    <if test="wineOriginId!=null and wineOriginId!=0">
      and wine.wine_origin_id=#{wineOriginId}
    </if>
    limit #{offset,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
  </select>
</mapper>